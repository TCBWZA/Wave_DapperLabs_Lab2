# Code Annotation Summary

This document explains the commenting approach used throughout the DapperLabs_Lab2 project to highlight API-specific and Dapper-specific features.

## Comment Tags

Throughout the codebase, you'll find two types of comment tags:

### `[API]` - API-Specific Features
These comments mark code elements that are specific to building a Web API with ASP.NET Core.

### `[DAPPER]` - Dapper-Specific Features
These comments mark code elements that are specific to using Dapper ORM for database operations.

## Files with Annotations

### 1. Controllers/CustomersController.cs

**API Features Highlighted:**
- `[ApiController]`, `[Route]`, `[Produces]` attributes for API behavior
- `ControllerBase` - Base class for API controllers (no view support)
- `ILogger<T>` - ASP.NET Core logging
- `[HttpGet]`, `[HttpPost]`, `[HttpPut]`, `[HttpDelete]` - HTTP verb routing
- `[ProducesResponseType]` - OpenAPI/Swagger response documentation
- `ActionResult<T>` - API response wrapper with status codes
- `[FromQuery]`, `[FromBody]` - Parameter binding from HTTP requests
- `Ok()`, `NotFound()`, `BadRequest()`, `NoContent()`, `CreatedAtAction()` - HTTP response helpers
- `PagedResultDto` - API pagination response model
- DTOs (CustomerDto, CreateCustomerDto, UpdateCustomerDto) - API data transfer objects

**Dapper Features Highlighted:**
- Repository method calls that execute parameterized SQL
- `OUTPUT INSERTED.Id` for getting auto-generated IDs (modern approach, preferred over SCOPE_IDENTITY)
- Dynamic SQL with `DynamicParameters`
- INSERT, UPDATE, DELETE, SELECT statements

### 2. Repositories/CustomerRepository.cs

**Dapper Features Highlighted:**
- `SqlConnection` - Manual connection management (no DbContext)
- `using` statements for connection disposal
- Raw SQL strings - Direct SQL execution
- `QueryFirstOrDefaultAsync<T>` - Single row mapping
- `QueryAsync<T>` - Multiple row mapping
- Anonymous objects for parameters - `new { Id = id }`
- `ExecuteScalarAsync<T>` - Scalar value retrieval (COUNT, SUM, identity)
- `ExecuteAsync` - Non-query execution (INSERT, UPDATE, DELETE)
- `DynamicParameters` - Safe dynamic SQL building
- OUTPUT INSERTED.Id for auto-generated IDs (modern approach, preferred over SCOPE_IDENTITY)
- OFFSET/FETCH NEXT for pagination
- IN clause with collections - `WHERE CustomerId IN @CustomerIds`
- Manual related data loading (no lazy loading)
- Batch loading to avoid N+1 queries
- Subqueries in WHERE clauses
- Manual relationship mapping

### 3. DTOs/CustomerDto.cs

**API Features Highlighted:**
- DTOs (Data Transfer Objects) - API-specific models
- `CreateDto` without ID (auto-generated by database)
- `UpdateDto` without ID (comes from route parameter)
- Data Annotations - `[Required]`, `[StringLength]`, `[EmailAddress]`
- Calculated properties for API responses (Balance)
- Related data properties (Invoices, PhoneNumbers)

### 4. DTOs/PagedResultDto.cs

**API Features Highlighted:**
- Pagination response model
- Calculated properties (TotalPages, HasPrevious, HasNext)
- Metadata for client-side pagination UI

### 5. Mappings/MappingExtensions.cs

**API Features Highlighted:**
- Entity to DTO mapping for API responses
- CreateDto to Entity mapping for POST requests
- UpdateDto to Entity updates for PUT requests
- Nested object mapping (related entities)
- ID handling differences between create/update

### 6. Program.cs

**API Features Highlighted:**
- `AddControllers()` - MVC controller registration
- `AddEndpointsApiExplorer()` - API explorer for Swagger
- `AddSwaggerGen()` - Swagger configuration
- XML comments for API documentation
- `AddConsole()`, `AddDebug()` - Logging providers
- `AddCors()` - Cross-origin resource sharing
- `UseSwagger()`, `UseSwaggerUI()` - Swagger middleware
- `MapControllers()` - Route HTTP requests to controllers

**Dapper Features Highlighted:**
- Connection string retrieving
- Repository registration with connection string (no DbContext)
- Manual database initialization (no EF migrations)
- Direct SQL execution for schema creation
- Data seeding with INSERT statements

### 7. Examples/AdvancedExamples.cs

**Dapper Features Highlighted:**
- Complex JOIN queries with GROUP BY
- SQL aggregations (SUM, COUNT, AVG, MIN, MAX)
- Database transactions (BeginTransaction, Commit, Rollback)
- Multi-mapping with `splitOn`
- Bulk operations (single UPDATE for multiple rows)
- DynamicParameters for safe dynamic SQL
- Custom result classes (POCOs)
- Column mapping (InvoiceCount from COUNT, TotalAmount from SUM)

## Key Differences Highlighted

### API vs. Traditional Console App

| Feature | Traditional | Web API |
|---------|------------|---------|
| Entry Point | `Main` method | `Program.cs` with `WebApplication` |
| Controllers | N/A | `[ApiController]` classes |
| Routing | N/A | Attribute-based routing `[HttpGet]` |
| Data Format | Objects | JSON via DTOs |
| Error Handling | Exceptions | HTTP status codes |
| Validation | Manual | Data Annotations |
| Documentation | Code comments | Swagger/OpenAPI |
| Logging | Console.WriteLine | ILogger<T> |

### Dapper vs. Entity Framework Core

| Feature | EF Core | Dapper |
|---------|---------|--------|
| Configuration | `DbContext` with `DbSet<T>` | Connection string only |
| Queries | LINQ expressions | Raw SQL strings |
| Mapping | Automatic | Property name matching |
| Change Tracking | Automatic | None (manual) |
| Relationships | Navigation properties | Manual loading |
| Parameters | Automatic | Anonymous objects |
| Identity Values | Automatic | OUTPUT INSERTED.Id |
| Migrations | Built-in | Manual SQL scripts |
| N+1 Prevention | Include/ThenInclude | Manual batch loading |

## How to Use These Annotations

### For Students Learning:

1. **Search for `[API]`** - Learn Web API patterns
   - See how HTTP verbs map to operations
   - Understand request/response flow
   - Learn validation and error handling

2. **Search for `[DAPPER]`** - Learn Dapper ORM patterns
   - See SQL query execution
   - Understand parameterization
   - Learn manual mapping techniques

3. **Compare Controllers vs. Repositories**
   - Controllers handle HTTP concerns (`[API]`)
   - Repositories handle database concerns (`[DAPPER]`)

### For Instructors:

1. **Highlight API Patterns**
   - Point to `[API]` comments for HTTP/REST concepts
   - Show how DTOs separate API from domain
   - Demonstrate dependency injection

2. **Explain Dapper Mechanics**
   - Point to `[DAPPER]` comments for ORM concepts
   - Compare with EF Core examples (if available)
   - Show performance benefits

3. **Discuss Trade-offs**
   - API complexity vs. functionality
   - Dapper control vs. EF Core convenience
   - Manual vs. automatic approaches

## Example Walkthrough

### Creating a Customer (API + Dapper)

**1. API Request arrives:**
```csharp
[HttpPost] // [API] POST endpoint
public async Task<ActionResult<CustomerDto>> Create([FromBody] CreateCustomerDto dto) // [API] JSON deserialization
```

**2. Validation occurs:**
```csharp
[Required] // [API] Validation attribute
[EmailAddress] // [API] Email format validation
```

**3. Map DTO to Entity:**
```csharp
var customer = dto.ToEntity(); // [API] DTO to Entity mapping
```

**4. Execute Dapper query:**
```csharp
var sql = @"INSERT INTO Customers (Name, Email) 
            OUTPUT INSERTED.Id
            VALUES (@Name, @Email)"; // [DAPPER] Raw SQL with OUTPUT clause
customer.Id = await connection.ExecuteScalarAsync<long>(sql, customer); // [DAPPER] Get inserted identity
```

**5. Return API response:**
```csharp
return CreatedAtAction(nameof(GetById), new { id = created.Id }, created.ToDto()); 
// [API] HTTP 201 Created with Location header and DTO response
```

## Benefits of This Approach

1. **Clear Learning Path** - Students can focus on one technology at a time
2. **Easy Comparison** - See how API and ORM concerns are separated
3. **Quick Reference** - Find examples of specific patterns easily
4. **Teaching Tool** - Instructors can highlight specific concepts
5. **Code Review** - Easily identify which layer a code element belongs to

## Search Tips

### In Visual Studio / VS Code:

**Find all API features:**
```
Search: \[API\]
```

**Find all Dapper features:**
```
Search: \[DAPPER\]
```

**Find API validation:**
```
Search: \[API\].*[Required|EmailAddress|StringLength]
```

**Find Dapper queries:**
```
Search: \[DAPPER\].*QueryAsync|ExecuteAsync
```

## Summary

This annotation strategy makes the codebase an excellent teaching tool by:
- Clearly identifying technology-specific code
- Separating concerns (API vs. Data Access)
- Providing context for learning
- Making patterns easy to find and study
- Facilitating code reviews and discussions

Students can learn both Web API development and Dapper ORM usage in a single, well-organized project with clear guidance on what belongs where.
